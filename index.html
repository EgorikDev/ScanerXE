<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkanerXE - AI –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –µ–¥—ã</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: #f5f5f5;
            color: #333;
            line-height: 1.4;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            position: relative;
        }
        
        /* Header */
        .header {
            background: white;
            padding: 50px 20px 20px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #000;
        }
        
        .header p {
            font-size: 14px;
            color: #666;
            margin-bottom: 25px;
        }
        
        .user-info {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logout-btn {
            background: #ff3b30;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .admin-badge {
            background: #ff9500;
            color: white;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 10px;
        }
        
        /* Balance Info */
        .balance-info {
            background: #4A90E2;
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin: 0 20px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .balance-amount {
            font-size: 24px;
            font-weight: 600;
        }
        
        .free-scans {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .topup-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* Scanner Section */
        .scanner-section {
            padding: 0 20px;
            margin-bottom: 30px;
        }
        
        .scanner-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            border: 1px solid #e0e0e0;
            margin-bottom: 20px;
        }
        
        .scanner-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .scanner-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .scanner-desc {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
        }
        
        .scan-btn {
            background: #4A90E2;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
        }
        
        /* Results */
        .results-section {
            padding: 0 20px;
            display: none;
        }
        
        .result-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            margin-bottom: 15px;
        }
        
        .result-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .nutrition-item {
            text-align: center;
            padding: 15px 10px;
            background: #f8f8f8;
            border-radius: 12px;
        }
        
        .nutrition-value {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .nutrition-label {
            font-size: 12px;
            color: #666;
        }
        
        .recommendations {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 12px;
            border-left: 4px solid #4A90E2;
            font-size: 14px;
            line-height: 1.5;
        }
        
        /* History */
        .history-section {
            padding: 0 20px;
            margin-bottom: 80px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .history-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #f0f0f0;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .food-name {
            font-size: 16px;
            font-weight: 500;
        }
        
        .food-calories {
            font-size: 16px;
            font-weight: 600;
            color: #000;
        }
        
        .food-macros {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #666;
        }
        
        .macro-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 0 20px;
            overflow-x: auto;
        }
        
        .tab {
            padding: 15px 20px;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
        }
        
        .tab.active {
            color: #4A90E2;
            border-bottom-color: #4A90E2;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 10px 20px;
            display: flex;
            justify-content: space-around;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 12px;
            color: #888;
            cursor: pointer;
        }
        
        .nav-item.active {
            color: #4A90E2;
        }
        
        .nav-icon {
            font-size: 20px;
            margin-bottom: 2px;
        }
        
        /* Auth Screens */
        .auth-screen {
            padding: 60px 20px;
            text-align: center;
        }
        
        .auth-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 30px;
            color: #4A90E2;
        }
        
        .auth-input {
            width: 100%;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .auth-button {
            width: 100%;
            padding: 15px;
            background: #4A90E2;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 15px;
        }
        
        .auth-switch {
            color: #4A90E2;
            background: none;
            border: none;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* Payments */
        .payments-section {
            padding: 20px;
        }
        
        .payment-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .payment-option {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
        }
        
        .payment-option.selected {
            border-color: #4A90E2;
            background: #f0f8ff;
        }
        
        .payment-amount {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .payment-scans {
            font-size: 12px;
            color: #666;
        }
        
        .robokassa-info {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
            font-size: 12px;
            color: #666;
        }
        
        /* Admin Panel */
        .admin-section {
            padding: 20px;
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .admin-stat {
            background: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 600;
            color: #4A90E2;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        
        /* Chat */
        .chat-section {
            padding: 20px;
            height: 500px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 12px;
        }
        
        .message {
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
        }
        
        .message.user {
            background: #4A90E2;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .message.bot {
            background: white;
            border: 1px solid #e0e0e0;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .chat-send {
            background: #4A90E2;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 12px 20px;
            cursor: pointer;
        }
        
        /* Hidden elements */
        .hidden {
            display: none;
        }
        
        /* Loader */
        .loader {
            text-align: center;
            padding: 40px 20px;
            display: none;
        }
        
        .loader-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4A90E2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Image Preview */
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            margin: 15px auto;
            border-radius: 12px;
            display: none;
        }
        
        /* Alert */
        .alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #4A90E2;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <div class="alert" id="alert"></div>
    
    <div class="container">
        <!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
        <div id="auth-screen" class="auth-screen">
            <h2 class="auth-title">SkanerXE</h2>
            <div id="login-form">
                <input type="email" class="auth-input" placeholder="Email" id="login-email">
                <input type="password" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å" id="login-password">
                <button class="auth-button" id="login-btn">–í–æ–π—Ç–∏</button>
                <button class="auth-switch" id="show-register">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            </div>
            <div id="register-form" class="hidden">
                <input type="email" class="auth-input" placeholder="Email" id="register-email">
                <input type="password" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å" id="register-password">
                <input type="password" class="auth-input" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" id="register-confirm">
                <button class="auth-button" id="register-btn">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                <button class="auth-switch" id="show-login">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
        <div id="main-app" class="hidden">
            <!-- Header -->
            <div class="header">
                <div class="user-info" id="user-info" style="display: none;">
                    <span id="user-email"></span>
                    <span class="admin-badge" id="admin-badge" style="display: none;">ADMIN</span>
                    <button class="logout-btn" id="logout-btn">–í—ã–π—Ç–∏</button>
                </div>
                <h1>SkanerXE</h1>
                <p>AI –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏ –∏ —Å–æ—Å—Ç–∞–≤–∞ –±–ª—é–¥</p>
            </div>

            <!-- Balance -->
            <div class="balance-info">
                <div>
                    <div class="balance-amount" id="balance-amount">0 —Ä—É–±</div>
                    <div class="free-scans" id="free-scans">–ë–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π: 0/10</div>
                </div>
                <button class="topup-btn" id="topup-btn">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" data-tab="scanner">–°–∫–∞–Ω–µ—Ä</div>
                <div class="tab" data-tab="chat">–ß–∞—Ç —Å AI</div>
                <div class="tab" data-tab="history">–ò—Å—Ç–æ—Ä–∏—è</div>
                <div class="tab" data-tab="payments">–ü–ª–∞—Ç–µ–∂–∏</div>
                <div class="tab admin-only" data-tab="admin" style="display: none;">–ê–¥–º–∏–Ω</div>
            </div>

            <!-- Scanner Tab -->
            <div class="tab-content active" id="scanner-tab">
                <div class="scanner-section">
                    <div class="scanner-card">
                        <div class="scanner-icon">üì∑</div>
                        <div class="scanner-title">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –µ–¥—ã</div>
                        <div class="scanner-desc">–°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ –±–ª—é–¥–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–∞–ª–æ—Ä–∏–π –∏ —Å–æ—Å—Ç–∞–≤–∞</div>
                        <input type="file" id="file-input" accept="image/*" style="display: none;">
                        <button class="scan-btn" id="scan-btn">–ù–∞—á–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
                    </div>

                    <img id="image-preview" class="image-preview" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä">

                    <div class="loader" id="scanner-loader">
                        <div class="loader-spinner"></div>
                        <div>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ...</div>
                    </div>

                    <div class="results-section" id="results-section">
                        <div class="result-card">
                            <div class="result-title" id="result-title">–°—Ç–µ–π–∫ —Å –æ–≤–æ—â–∞–º–∏</div>
                            <div class="nutrition-grid">
                                <div class="nutrition-item">
                                    <div class="nutrition-value" id="calories-value">750</div>
                                    <div class="nutrition-label">–∫–∫–∞–ª</div>
                                </div>
                                <div class="nutrition-item">
                                    <div class="nutrition-value" id="protein-value">87–≥</div>
                                    <div class="nutrition-label">–±–µ–ª–∫–∏</div>
                                </div>
                                <div class="nutrition-item">
                                    <div class="nutrition-value" id="fat-value">22–≥</div>
                                    <div class="nutrition-label">–∂–∏—Ä—ã</div>
                                </div>
                                <div class="nutrition-item">
                                    <div class="nutrition-value" id="carbs-value">120–≥</div>
                                    <div class="nutrition-label">—É–≥–ª–µ–≤–æ–¥—ã</div>
                                </div>
                                <div class="nutrition-item">
                                    <div class="nutrition-value" id="weight-value">350–≥</div>
                                    <div class="nutrition-label">–≤–µ—Å</div>
                                </div>
                                <div class="nutrition-item">
                                    <div class="nutrition-value" id="units-value">10</div>
                                    <div class="nutrition-label">–•–ï</div>
                                </div>
                            </div>
                            <div class="recommendations" id="recommendations">
                                –û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä! –ë–ª—é–¥–æ –±–æ–≥–∞—Ç–æ –±–µ–ª–∫–æ–º –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–µ–∑–Ω—ã–µ –æ–≤–æ—â–∏.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Tab -->
            <div class="tab-content" id="chat-tab">
                <div class="chat-section">
                    <div class="chat-messages" id="chat-messages">
                        <div class="message bot">
                            –ü—Ä–∏–≤–µ—Ç! –Ø AI-–Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥. –°–ø—Ä–æ—Å–∏—Ç–µ –º–µ–Ω—è –æ –ø–∏—Ç–∞–Ω–∏–∏, –¥–∏–µ—Ç–∞—Ö –∏–ª–∏ –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤!
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="chat-input" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å...">
                        <button class="chat-send" id="chat-send">–û—Ç–ø—Ä</button>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div class="tab-content" id="history-tab">
                <div class="history-section">
                    <div class="section-title">–ò—Å—Ç–æ—Ä–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</div>
                    <div id="history-list">
                        <!-- –ò—Å—Ç–æ—Ä–∏—è –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                </div>
            </div>

            <!-- Payments Tab -->
            <div class="tab-content" id="payments-tab">
                <div class="payments-section">
                    <div class="section-title">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</div>
                    <div class="payment-options">
                        <div class="payment-option" data-amount="50">
                            <div class="payment-amount">50 —Ä—É–±</div>
                            <div class="payment-scans">+50 —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</div>
                        </div>
                        <div class="payment-option" data-amount="100">
                            <div class="payment-amount">100 —Ä—É–±</div>
                            <div class="payment-scans">+100 —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</div>
                        </div>
                        <div class="payment-option" data-amount="500">
                            <div class="payment-amount">500 —Ä—É–±</div>
                            <div class="payment-scans">+500 —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</div>
                        </div>
                        <div class="payment-option" data-amount="1000">
                            <div class="payment-amount">1000 —Ä—É–±</div>
                            <div class="payment-scans">+1000 —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</div>
                        </div>
                    </div>
                    <button class="scan-btn" id="payment-btn">–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ —á–µ—Ä–µ–∑ Robokassa</button>
                    
                    <div class="robokassa-info">
                        üí≥ –û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ –∑–∞—â–∏—â–µ–Ω–Ω—ã–π —à–ª—é–∑ Robokassa. –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –±–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
                    </div>

                    <div style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 12px;">
                        <div class="section-title">–û–∂–∏–¥–∞—é—â–∏–µ –ø–ª–∞—Ç–µ–∂–∏</div>
                        <div id="pending-payments">
                            <p>–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π</p>
                        </div>
                        <button class="topup-btn" style="background: #4A90E2; color: white; margin-top: 10px;" id="check-payments-btn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–ª–∞—Ç–µ–∂–∏</button>
                    </div>
                </div>
            </div>

            <!-- Admin Tab -->
            <div class="tab-content" id="admin-tab">
                <div class="admin-section">
                    <div class="section-title">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</div>
                    
                    <div class="admin-stats">
                        <div class="admin-stat">
                            <div class="stat-value" id="stat-users">0</div>
                            <div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                        </div>
                        <div class="admin-stat">
                            <div class="stat-value" id="stat-balance">0 —Ä—É–±</div>
                            <div class="stat-label">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</div>
                        </div>
                        <div class="admin-stat">
                            <div class="stat-value" id="stat-scans">0</div>
                            <div class="stat-label">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</div>
                        </div>
                        <div class="admin-stat">
                            <div class="stat-value" id="stat-payments">0</div>
                            <div class="stat-label">–ü–ª–∞—Ç–µ–∂–µ–π</div>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <div class="section-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</div>
                        <input type="number" class="auth-input" id="min-payment" placeholder="–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂" value="50">
                        <input type="number" class="auth-input" id="price-per-scan" placeholder="–¶–µ–Ω–∞ –∑–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ" value="1">
                        <button class="auth-button" id="save-settings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                    </div>
                </div>
            </div>

            <!-- Bottom Navigation -->
            <div class="bottom-nav">
                <div class="nav-item active" data-tab="scanner">
                    <div class="nav-icon">üì∑</div>
                    <div>–°–∫–∞–Ω–µ—Ä</div>
                </div>
                <div class="nav-item" data-tab="chat">
                    <div class="nav-icon">üí¨</div>
                    <div>–ß–∞—Ç</div>
                </div>
                <div class="nav-item" data-tab="history">
                    <div class="nav-icon">üìä</div>
                    <div>–ò—Å—Ç–æ—Ä–∏—è</div>
                </div>
                <div class="nav-item" data-tab="payments">
                    <div class="nav-icon">üí≥</div>
                    <div>–ü–ª–∞—Ç–µ–∂–∏</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== –ë–ê–ó–ê –î–ê–ù–ù–´–• ====================
        class Database {
            constructor() {
                this.users = JSON.parse(localStorage.getItem('skanerxe_users')) || {};
                this.scans = JSON.parse(localStorage.getItem('skanerxe_scans')) || {};
                this.payments = JSON.parse(localStorage.getItem('skanerxe_payments')) || {};
                this.chatHistory = JSON.parse(localStorage.getItem('skanerxe_chat')) || {};
                this.settings = JSON.parse(localStorage.getItem('skanerxe_settings')) || {
                    price_per_scan: 1,
                    min_payment: 50
                };
                
                // –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                if (!this.users['admin@skanerxe.ru']) {
                    this.users['admin@skanerxe.ru'] = {
                        password: this.hashPassword('admin123'),
                        balance: 1000,
                        free_scans: 999,
                        is_admin: true,
                        created_at: new Date().toISOString()
                    };
                    this.saveUsers();
                }
            }
            
            saveUsers() { localStorage.setItem('skanerxe_users', JSON.stringify(this.users)); }
            saveScans() { localStorage.setItem('skanerxe_scans', JSON.stringify(this.scans)); }
            savePayments() { localStorage.setItem('skanerxe_payments', JSON.stringify(this.payments)); }
            saveChat() { localStorage.setItem('skanerxe_chat', JSON.stringify(this.chatHistory)); }
            saveSettings() { localStorage.setItem('skanerxe_settings', JSON.stringify(this.settings)); }
            
            hashPassword(password) { return btoa(password); }
            
            registerUser(email, password) {
                if (this.users[email]) return { success: false, error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç' };
                
                this.users[email] = {
                    password: this.hashPassword(password),
                    balance: 0,
                    free_scans: 10,
                    is_admin: false,
                    created_at: new Date().toISOString()
                };
                this.saveUsers();
                return { success: true };
            }
            
            loginUser(email, password) {
                const user = this.users[email];
                if (!user) return { success: false, error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' };
                if (user.password !== this.hashPassword(password)) return { success: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å' };
                
                return { 
                    success: true, 
                    user: {
                        email: email,
                        balance: user.balance,
                        free_scans: user.free_scans,
                        is_admin: user.is_admin
                    }
                };
            }
            
            addScan(email, scanData) {
                const scanId = 'scan_' + Date.now();
                this.scans[scanId] = { ...scanData, user_email: email, created_at: new Date().toISOString() };
                this.saveScans();
                return scanId;
            }
            
            getUserScans(email) {
                return Object.values(this.scans)
                    .filter(scan => scan.user_email === email)
                    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            }
            
            useFreeScan(email) {
                if (this.users[email] && this.users[email].free_scans > 0) {
                    this.users[email].free_scans--;
                    this.saveUsers();
                    return true;
                }
                return false;
            }
            
            chargeForScan(email) {
                if (this.users[email] && this.users[email].balance >= this.settings.price_per_scan) {
                    this.users[email].balance -= this.settings.price_per_scan;
                    this.saveUsers();
                    return true;
                }
                return false;
            }
            
            addPayment(email, amount) {
                const paymentId = 'pay_' + Date.now();
                this.payments[paymentId] = {
                    user_email: email,
                    amount: amount,
                    status: 'pending',
                    created_at: new Date().toISOString()
                };
                this.savePayments();
                return paymentId;
            }
            
            completePayment(paymentId) {
                if (this.payments[paymentId]) {
                    this.payments[paymentId].status = 'completed';
                    const payment = this.payments[paymentId];
                    this.updateBalance(payment.user_email, payment.amount);
                    this.savePayments();
                    return true;
                }
                return false;
            }
            
            updateBalance(email, amount) {
                if (this.users[email]) {
                    this.users[email].balance += amount;
                    this.saveUsers();
                    return true;
                }
                return false;
            }
            
            getPendingPayments(email) {
                return Object.values(this.payments)
                    .filter(payment => payment.user_email === email && payment.status === 'pending');
            }
            
            getAllUsers() {
                return Object.entries(this.users).map(([email, data]) => ({ email, ...data }));
            }
            
            getStats() {
                const users = this.getAllUsers();
                return {
                    total_users: users.length,
                    total_balance: users.reduce((sum, user) => sum + user.balance, 0),
                    total_scans: Object.keys(this.scans).length,
                    pending_payments: Object.values(this.payments).filter(p => p.status === 'pending').length
                };
            }
            
            addChatMessage(email, message, isUser = true) {
                if (!this.chatHistory[email]) this.chatHistory[email] = [];
                this.chatHistory[email].push({ message, is_user: isUser, timestamp: new Date().toISOString() });
                if (this.chatHistory[email].length > 50) this.chatHistory[email] = this.chatHistory[email].slice(-50);
                this.saveChat();
            }
            
            getChatHistory(email) { return this.chatHistory[email] || []; }
        }

        // ==================== ROBOKASSA ====================
        class RobokassaPayment {
            constructor() {
                this.login = "SkanerXEbot";
                this.password1 = "c7zMQKpaDT979pB3WhUO";
                this.password2 = "gvTgn6Bh5T6VUhu8RG6t";
                this.isTestMode = true; // –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ false
            }
            
            generateSignature(amount, paymentId, userId, password) {
                const signatureString = `${this.login}:${amount}:${paymentId}:${password}:shp_userId=${userId}`;
                return this.md5(signatureString).toLowerCase();
            }
            
            generatePaymentLink(amount, paymentId, userId, description = "–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ SkanerXE") {
                const crc = this.generateSignature(amount, paymentId, userId, this.password1);
                
                let baseUrl = "https://auth.robokassa.ru/Merchant/Index.aspx?";
                if (this.isTestMode) baseUrl += "IsTest=1&";
                
                return baseUrl +
                       `MerchantLogin=${this.login}&` +
                       `OutSum=${amount}&` +
                       `InvId=${paymentId}&` +
                       `Description=${encodeURIComponent(description)}&` +
                       `SignatureValue=${crc}&` +
                       `shp_userId=${userId}`;
            }
            
            md5(input) {
                let hash = 0;
                if (input.length === 0) return hash.toString(16);
                for (let i = 0; i < input.length; i++) {
                    const char = input.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(16);
            }
            
            async checkPaymentStatus(paymentId) {
                // –ò–º–∏—Ç–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞
                return new Promise(resolve => {
                    setTimeout(() => {
                        resolve(Math.random() > 0.3 ? 'paid' : 'pending');
                    }, 1000);
                });
            }
        }

        // ==================== AI –ê–ù–ê–õ–ò–ó–ê–¢–û–† ====================
        class FoodAnalyzer {
            async analyzeImage(imageData) {
                const dishes = [
                    {
                        name: '–°—Ç–µ–π–∫ —Å –æ–≤–æ—â–∞–º–∏',
                        calories: 750, protein: 87, fat: 22, carbs: 120, weight: 350, units: 10,
                        recommendation: '–û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä! –ë–ª—é–¥–æ –±–æ–≥–∞—Ç–æ –±–µ–ª–∫–æ–º –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–µ–∑–Ω—ã–µ –æ–≤–æ—â–∏. –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.'
                    },
                    {
                        name: '–ö—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞ —Å –±—Ä–æ–∫–∫–æ–ª–∏',
                        calories: 320, protein: 45, fat: 8, carbs: 25, weight: 280, units: 2,
                        recommendation: '–î–∏–µ—Ç–∏—á–µ—Å–∫–æ–µ –±–ª—é–¥–æ —Å –≤—ã—Å–æ–∫–∏–º —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ–º –±–µ–ª–∫–∞. –û—Ç–ª–∏—á–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ø–æ—Ö—É–¥–µ–Ω–∏—è.'
                    },
                    {
                        name: '–ü–∞—Å—Ç–∞ –∫–∞—Ä–±–æ–Ω–∞—Ä–∞',
                        calories: 620, protein: 25, fat: 32, carbs: 68, weight: 300, units: 5.7,
                        recommendation: '–ö–∞–ª–æ—Ä–∏–π–Ω–æ–µ –±–ª—é–¥–æ, –±–æ–≥–∞—Ç–æ–µ —É–≥–ª–µ–≤–æ–¥–∞–º–∏. –•–æ—Ä–æ—à–∏–π –∏—Å—Ç–æ—á–Ω–∏–∫ —ç–Ω–µ—Ä–≥–∏–∏.'
                    }
                ];
                
                return new Promise(resolve => {
                    setTimeout(() => {
                        const randomDish = dishes[Math.floor(Math.random() * dishes.length)];
                        resolve(randomDish);
                    }, 2000);
                });
            }
        }

        // ==================== AI –ß–ê–¢ ====================
        class NutritionAI {
            getResponse(message) {
                const responses = {
                    greeting: [
                        "–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à AI-–Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥. –ì–æ—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –ø–∏—Ç–∞–Ω–∏–∏!",
                        "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ó–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –æ –¥–∏–µ—Ç–∞—Ö –∏ –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏.",
                        "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é! –Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –æ –ø–∏—Ç–∞–Ω–∏–∏."
                    ],
                    calories: [
                        "–ö–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–æ—Å—Ç–∞–≤–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏ —Å–ø–æ—Å–æ–±–∞ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è.",
                        "–î–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∫–∞–ª–æ—Ä–∏–π –≤–∞–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å –ë–ñ–£ –ø—Ä–æ–¥—É–∫—Ç–æ–≤.",
                        "–°—Ä–µ–¥–Ω—è—è —Å—É—Ç–æ—á–Ω–∞—è –Ω–æ—Ä–º–∞: 2000-2500 –∫–∫–∞–ª –¥–ª—è –∂–µ–Ω—â–∏–Ω, 2500-3000 –¥–ª—è –º—É–∂—á–∏–Ω."
                    ],
                    diet: [
                        "–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–∏–µ—Ç–∞ –¥–æ–ª–∂–Ω–∞ –≤–∫–ª—é—á–∞—Ç—å –±–µ–ª–∫–∏, —É–≥–ª–µ–≤–æ–¥—ã, –∂–∏—Ä—ã, –≤–∏—Ç–∞–º–∏–Ω—ã.",
                        "–†–µ–∫–æ–º–µ–Ω–¥—É—é –±–æ–ª—å—à–µ –æ–≤–æ—â–µ–π, —Ü–µ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤—ã—Ö –∏ –Ω–µ–∂–∏—Ä–Ω–æ–≥–æ –±–µ–ª–∫–∞.",
                        "–í–∞–∂–Ω–æ —Å–æ–±–ª—é–¥–∞—Ç—å –ø–∏—Ç—å–µ–≤–æ–π —Ä–µ–∂–∏–º - 1.5-2 –ª–∏—Ç—Ä–∞ –≤–æ–¥—ã –≤ –¥–µ–Ω—å."
                    ],
                    default: [
                        "–ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –î–ª—è —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω—É–∂–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è.",
                        "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–æ–ø—Ä–æ—Å! –ú–æ–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–æ—Å—è—Ç –æ–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä."
                    ]
                };
                
                const lowerMessage = message.toLowerCase();
                if (lowerMessage.includes('–ø—Ä–∏–≤–µ—Ç')) return this.getRandomResponse('greeting');
                if (lowerMessage.includes('–∫–∞–ª–æ—Ä–∏')) return this.getRandomResponse('calories');
                if (lowerMessage.includes('–¥–∏–µ—Ç')) return this.getRandomResponse('diet');
                return this.getRandomResponse('default');
            }
            
            getRandomResponse(type) {
                const responses = this.responses[type] || this.responses.default;
                return responses[Math.floor(Math.random() * responses.length)];
            }
        }

        // ==================== –û–°–ù–û–í–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï ====================
        class SkanerXEApp {
            constructor() {
                this.db = new Database();
                this.analyzer = new FoodAnalyzer();
                this.robokassa = new RobokassaPayment();
                this.nutritionAI = new NutritionAI();
                this.currentUser = null;
                this.selectedPaymentAmount = 50;
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.checkAuth();
                this.startPaymentChecker();
            }
            
            setupEventListeners() {
                // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
                document.getElementById('login-btn').addEventListener('click', () => this.login());
                document.getElementById('register-btn').addEventListener('click', () => this.register());
                document.getElementById('show-register').addEventListener('click', () => this.showRegister());
                document.getElementById('show-login').addEventListener('click', () => this.showLogin());
                document.getElementById('logout-btn').addEventListener('click', () => this.logout());
                
                // –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                document.getElementById('scan-btn').addEventListener('click', () => this.startScan());
                document.getElementById('file-input').addEventListener('change', (e) => this.handleImageUpload(e));
                
                // –ß–∞—Ç
                document.getElementById('chat-send').addEventListener('click', () => this.sendChatMessage());
                document.getElementById('chat-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendChatMessage();
                });
                
                // –ü–ª–∞—Ç–µ–∂–∏
                document.querySelectorAll('.payment-option').forEach(option => {
                    option.addEventListener('click', () => this.selectPaymentOption(option));
                });
                document.getElementById('payment-btn').addEventListener('click', () => this.processPayment());
                document.getElementById('topup-btn').addEventListener('click', () => this.showPaymentsTab());
                document.getElementById('check-payments-btn').addEventListener('click', () => this.checkPendingPayments());
                
                // –ê–¥–º–∏–Ω
                document.getElementById('save-settings').addEventListener('click', () => this.saveSettings());
                
                // –ù–∞–≤–∏–≥–∞—Ü–∏—è
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
                });
                document.querySelectorAll('.nav-item').forEach(nav => {
                    nav.addEventListener('click', () => this.switchTab(nav.dataset.tab));
                });
            }
            
            checkAuth() {
                const savedUser = localStorage.getItem('current_user');
                if (savedUser) {
                    this.currentUser = JSON.parse(savedUser);
                    this.showMainApp();
                }
            }
            
            showRegister() {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.remove('hidden');
            }
            
            showLogin() {
                document.getElementById('register-form').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
            }
            
            login() {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                if (!email || !password) {
                    this.showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                    return;
                }
                
                const result = this.db.loginUser(email, password);
                if (result.success) {
                    this.currentUser = result.user;
                    localStorage.setItem('current_user', JSON.stringify(this.currentUser));
                    this.showMainApp();
                    this.showAlert('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!', 'success');
                } else {
                    this.showAlert(result.error, 'error');
                }
            }
            
            register() {
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const confirm = document.getElementById('register-confirm').value;
                
                if (!email || !password || !confirm) {
                    this.showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                    return;
                }
                
                if (password !== confirm) {
                    this.showAlert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
                    return;
                }
                
                if (password.length < 6) {
                    this.showAlert('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                    return;
                }
                
                const result = this.db.registerUser(email, password);
                if (result.success) {
                    this.showAlert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!', 'success');
                    this.showLogin();
                } else {
                    this.showAlert(result.error, 'error');
                }
            }
            
            logout() {
                this.currentUser = null;
                localStorage.removeItem('current_user');
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('hidden');
            }
            
            showMainApp() {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('user-info').style.display = 'flex';
                document.getElementById('user-email').textContent = this.currentUser.email;
                
                if (this.currentUser.is_admin) {
                    document.getElementById('admin-badge').style.display = 'inline-block';
                    document.querySelectorAll('.admin-only').forEach(el => {
                        el.style.display = 'block';
                    });
                    this.loadAdminData();
                }
                
                this.updateUI();
                this.loadHistory();
                this.loadChatHistory();
            }
            
            updateUI() {
                if (!this.currentUser) return;
                
                document.getElementById('balance-amount').textContent = this.currentUser.balance + ' —Ä—É–±';
                document.getElementById('free-scans').textContent = `–ë–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π: ${this.currentUser.free_scans}/10`;
                
                const scanBtn = document.getElementById('scan-btn');
                if (this.currentUser.free_scans > 0) {
                    scanBtn.textContent = `–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å (–±–µ—Å–ø–ª–∞—Ç–Ω–æ, –æ—Å—Ç–∞–ª–æ—Å—å: ${this.currentUser.free_scans})`;
                } else {
                    scanBtn.textContent = `–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å (${this.db.settings.price_per_scan} —Ä—É–±)`;
                }
            }
            
            startScan() {
                document.getElementById('file-input').click();
            }
            
            async handleImageUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                if (!file.type.match('image.*')) {
                    this.showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', 'error');
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
                if (this.currentUser.free_scans <= 0 && this.currentUser.balance < this.db.settings.price_per_scan) {
                    this.showAlert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å.', 'error');
                    this.showPaymentsTab();
                    return;
                }
                
                // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–≤—å—é
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('image-preview').src = e.target.result;
                    document.getElementById('image-preview').style.display = 'block';
                };
                reader.readAsDataURL(file);
                
                // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
                document.getElementById('scanner-loader').style.display = 'block';
                document.getElementById('scan-btn').disabled = true;
                
                try {
                    const result = await this.analyzer.analyzeImage(file);
                    
                    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    const scanId = this.db.addScan(this.currentUser.email, result);
                    
                    // –°–ø–∏—Å–∞—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞
                    if (this.currentUser.free_scans > 0) {
                        this.db.useFreeScan(this.currentUser.email);
                    } else {
                        this.db.chargeForScan(this.currentUser.email);
                    }
                    
                    // –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                    this.currentUser.free_scans = this.db.users[this.currentUser.email].free_scans;
                    this.currentUser.balance = this.db.users[this.currentUser.email].balance;
                    localStorage.setItem('current_user', JSON.stringify(this.currentUser));
                    
                    this.showResults(result);
                    this.updateUI();
                    this.loadHistory();
                    this.showAlert('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!', 'success');
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
                    this.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
                } finally {
                    document.getElementById('scanner-loader').style.display = 'none';
                    document.getElementById('scan-btn').disabled = false;
                }
            }
            
            showResults(result) {
                document.getElementById('result-title').textContent = result.name;
                document.getElementById('calories-value').textContent = result.calories;
                document.getElementById('protein-value').textContent = result.protein + '–≥';
                document.getElementById('fat-value').textContent = result.fat + '–≥';
                document.getElementById('carbs-value').textContent = result.carbs + '–≥';
                document.getElementById('weight-value').textContent = result.weight + '–≥';
                document.getElementById('units-value').textContent = result.units;
                document.getElementById('recommendations').textContent = result.recommendation;
                
                document.getElementById('results-section').style.display = 'block';
            }
            
            loadHistory() {
                if (!this.currentUser) return;
                
                const scans = this.db.getUserScans(this.currentUser.email);
                const container = document.getElementById('history-list');
                
                if (scans.length === 0) {
                    container.innerHTML = '<div class="history-item">–ù–µ—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</div>';
                    return;
                }
                
                let html = '';
                scans.slice(0, 10).forEach(scan => {
                    html += `
                        <div class="history-item">
                            <div class="history-header">
                                <div class="food-name">${scan.name}</div>
                                <div class="food-calories">${scan.calories} –∫–∫–∞–ª</div>
                            </div>
                            <div class="food-macros">
                                <div class="macro-item">${scan.protein}–≥ –±–µ–ª–∫–æ–≤</div>
                                <div class="macro-item">${scan.fat}–≥ –∂–∏—Ä–æ–≤</div>
                                <div class="macro-item">${scan.carbs}–≥ —É–≥–ª–µ–≤–æ–¥–æ–≤</div>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            }
            
            // ==================== –ß–ê–¢ ====================
            sendChatMessage() {
                const input = document.getElementById('chat-input');
                const message = input.value.trim();
                if (!message) return;
                
                this.addChatMessage(message, true);
                input.value = '';
                
                // –û—Ç–≤–µ—Ç AI
                setTimeout(() => {
                    const response = this.nutritionAI.getResponse(message);
                    this.addChatMessage(response, false);
                }, 1000);
            }
            
            addChatMessage(message, isUser) {
                const chatMessages = document.getElementById('chat-messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
                messageDiv.textContent = message;
                chatMessages.appendChild(messageDiv);
                
                if (this.currentUser) {
                    this.db.addChatMessage(this.currentUser.email, message, isUser);
                }
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            loadChatHistory() {
                if (!this.currentUser) return;
                const history = this.db.getChatHistory(this.currentUser.email);
                const chatMessages = document.getElementById('chat-messages');
                
                if (history.length > 0) {
                    chatMessages.innerHTML = '';
                    history.forEach(msg => {
                        this.addChatMessage(msg.message, msg.is_user);
                    });
                }
            }
            
            // ==================== ROBOKASSA –ü–õ–ê–¢–ï–ñ–ò ====================
            selectPaymentOption(option) {
                document.querySelectorAll('.payment-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                option.classList.add('selected');
                this.selectedPaymentAmount = parseInt(option.dataset.amount);
            }
            
            async processPayment() {
                if (this.selectedPaymentAmount < this.db.settings.min_payment) {
                    this.showAlert(`–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: ${this.db.settings.min_payment} —Ä—É–±`, 'error');
                    return;
                }
                
                try {
                    // –°–æ–∑–¥–∞–µ–º –ø–ª–∞—Ç–µ–∂ –≤ –±–∞–∑–µ
                    const paymentId = this.db.addPayment(this.currentUser.email, this.selectedPaymentAmount);
                    
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É Robokassa
                    const userId = this.currentUser.email.replace(/[^a-zA-Z0-9]/g, '_');
                    const paymentUrl = this.robokassa.generatePaymentLink(
                        this.selectedPaymentAmount, 
                        paymentId, 
                        userId
                    );
                    
                    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–ª–∞—Ç–µ–∂–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    window.open(paymentUrl, '_blank');
                    this.showAlert(`–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã ${this.selectedPaymentAmount} —Ä—É–±...`, 'success');
                    
                } catch (error) {
                    this.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞', 'error');
                }
            }
            
            async checkPendingPayments() {
                if (!this.currentUser) return;
                
                const pendingPayments = this.db.getPendingPayments(this.currentUser.email);
                const container = document.getElementById('pending-payments');
                
                if (pendingPayments.length === 0) {
                    container.innerHTML = '<p>–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π</p>';
                    return;
                }
                
                let completed = 0;
                for (const payment of pendingPayments) {
                    const status = await this.robokassa.checkPaymentStatus(payment.id);
                    if (status === 'paid') {
                        this.db.completePayment(payment.id);
                        completed++;
                    }
                }
                
                if (completed > 0) {
                    this.currentUser.balance = this.db.users[this.currentUser.email].balance;
                    localStorage.setItem('current_user', JSON.stringify(this.currentUser));
                    this.updateUI();
                    this.showAlert(`–ó–∞—á–∏—Å–ª–µ–Ω–æ ${completed} –ø–ª–∞—Ç–µ–∂–µ–π!`, 'success');
                }
                
                this.loadPendingPayments();
            }
            
            loadPendingPayments() {
                if (!this.currentUser) return;
                const pendingPayments = this.db.getPendingPayments(this.currentUser.email);
                const container = document.getElementById('pending-payments');
                
                if (pendingPayments.length === 0) {
                    container.innerHTML = '<p>–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π</p>';
                } else {
                    let html = '';
                    pendingPayments.forEach(payment => {
                        html += `
                            <div style="padding: 10px; border-bottom: 1px solid #e0e0e0;">
                                <strong>${payment.amount} —Ä—É–±</strong> - ${payment.status}
                                <br><small>${new Date(payment.created_at).toLocaleString()}</small>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                }
            }
            
            startPaymentChecker() {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–ª–∞—Ç–µ–∂–∏ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
                setInterval(() => {
                    if (this.currentUser) {
                        this.checkPendingPayments();
                    }
                }, 30000);
            }
            
            // ==================== –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ ====================
            loadAdminData() {
                const stats = this.db.getStats();
                document.getElementById('stat-users').textContent = stats.total_users;
                document.getElementById('stat-balance').textContent = stats.total_balance + ' —Ä—É–±';
                document.getElementById('stat-scans').textContent = stats.total_scans;
                document.getElementById('stat-payments').textContent = stats.pending_payments;
                
                document.getElementById('min-payment').value = this.db.settings.min_payment;
                document.getElementById('price-per-scan').value = this.db.settings.price_per_scan;
            }
            
            saveSettings() {
                const minPayment = parseInt(document.getElementById('min-payment').value);
                const pricePerScan = parseInt(document.getElementById('price-per-scan').value);
                
                if (minPayment < 10 || pricePerScan < 1) {
                    this.showAlert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
                    return;
                }
                
                this.db.settings.min_payment = minPayment;
                this.db.settings.price_per_scan = pricePerScan;
                this.db.saveSettings();
                this.showAlert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
            }
            
            // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ú–ï–¢–û–î–´ ====================
            showPaymentsTab() {
                this.switchTab('payments');
            }
            
            switchTab(tabName) {
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
                
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}-tab`).classList.add('active');
                
                document.querySelectorAll('.nav-item').forEach(nav => {
                    nav.classList.remove('active');
                });
                document.querySelector(`.nav-item[data-tab="${tabName}"]`).classList.add('active');
                
                if (tabName === 'payments') {
                    this.loadPendingPayments();
                }
            }
            
            showAlert(message, type) {
                const alert = document.getElementById('alert');
                alert.textContent = message;
                alert.style.background = type === 'success' ? '#4A90E2' : '#ff3b30';
                alert.style.display = 'block';
                
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 3000);
            }
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            new SkanerXEApp();
        });
    </script>
</body>
</html>
